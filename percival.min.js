/*! percival - v1.0.0-beta - 2013-10-17
* https://github.com/lorem--ipsum/percival
* Copyright (c) 2013 Lorem Ipsum  Licensed ,  */
angular.module("percival-utils",[]).factory("$stringUtils",["$syntaxUtils",function(a){var b=a.getOperators();return{fromExpression:function(a,b){return this._isSingleCondition(a)?{and:[this._itemFromString(a,b)]}:this._fromString(a,b)},_isSingleCondition:function(a){var b=a.match(/^([a-zA-Z_]+)\s(!=|==)\s("?\w+"?)$/);return!!b},_fromString:function(a,b){return this._isSingleCondition(a)?this._itemFromString(a,b):this._groupFromString(a,b)},_itemFromString:function(a,c){var d=a.match(/([a-zA-Z_]+)\s(!=|==|is|is\snot|>=|>|<=|<)\s("?\w+"?)/),e=c.filter(function(a){return a.field===d[1]})[0],f=b[e.realtype],g=f.filter(function(a){return a.label===d[2]})[0];return{field:d[1],op:{text:g.label,id:g.value},rhs:{realtype:e.realtype,value:"string"===e.realtype?d[3].replace(/"/g,""):d[3]}}},_groupFromString:function(a,b){var c=this._parseGroup(a),d=this._getGroupType(c.string);if(!d)return void 0;var e={};e[d]=[];for(var f=c.string.split(" "+d+" "),g=0;g<f.length;g++)f[g].match(/_\d+_/)?e[d].push(this._groupFromString(c.groups[+f[g].replace(/_/g,"")],b)):e[d].push(this._itemFromString(f[g],b));return e},_parseGroup:function(a){for(var b={},c=0,d=!1,e=0,f="",g=[];c<a.length;)"("===a.charAt(c)&&(e++,d=!0),d&&(f+=a.charAt(c)),")"===a.charAt(c)&&(e--,d=e>0),d||""===f||(g.unshift(f),f=""),c++;return g.forEach(function(c,d){a=a.replace(c,"_"+d+"_"),b[d]=c.replace(/^\(/,"").replace(/\)$/,"")},this),{string:a,groups:b}},_getGroupType:function(a){a=a.replace(/"[^"]*"/g,"");var b=null!==a.match(/\sand\s/),c=null!==a.match(/\sor\s/);return b&&c?null:b?"and":"or"},toExpression:function(a){return this._groupToString(a)},_toString:function(a){return a.and||a.or?"("+this._groupToString(a)+")":this._itemToString(a)},_itemToString:function(a){return a.field+" "+a.op.text+" "+("string"===a.rhs.realtype?'"'+a.rhs.value+'"':a.rhs.value)},_groupToString:function(a){return(a.and||a.or).map(this._toString,this).join(a.and?" and ":" or ")}}}]).factory("$syntaxUtils",function(){var a={string:[{label:"is",value:"eq"},{label:"is not",value:"neq"}],"int":[{label:"==",value:"eq"},{label:"!=",value:"ne"}],datems:[{label:">=",value:"ge"},{label:"==",value:"eq"},{label:"!=",value:"ne"},{label:">",value:"gt"},{label:"<",value:"lt"},{label:"<=",value:"le"}]},b=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0};return{isValidAst:function(a){return b(a)?!1:!0},getOperators:function(){return a},getChildrenCount:function(a,b){for(var c=b.indexOf(a),d=0,e=a.level;c+1<b.length&&b[c+1].level>a.level;)e=b[c].level,c++,d++;return d},getIndexOfLastChild:function(a,b){for(var c=b.indexOf(a),d=a.level;c+1<b.length&&b[c+1].level>a.level;)d=b[c].level,c++;return c},parseSyntaxTree:function(a,b){return this._parseSyntaxTree(a,[],0,b)},parseSyntaxGroup:function(a,b){return a.and||a.or?{groupType:a.and?"and":"or",isGroup:!0,level:b}:void 0},parseSyntaxItem:function(b,c,d){var e=d.filter(function(a){return a.field===b.field})[0],f=a[e.realtype],g=f.filter(function(a){return b.op.id===a.value})[0];return{type:e,operators:a[e.realtype],operator:g,value:b.rhs.value,level:c}},_parseSyntaxTree:function(a,b,c,d){if(b=b||[],c=c||0,a.and||a.or){var e=this;b.push(this.parseSyntaxGroup(a,c)),(a.and||a.or).forEach(function(a){e._parseSyntaxTree(a,b,c+1,d)})}else b.push(this.parseSyntaxItem(a,c,d));return b},computeSyntaxTree:function(a){return this._getTree(a,0)},_getTree:function(a,b){for(var c={},d=c[a[b].groupType]=[],e=b+1,f=this.getIndexOfLastChild(a[b],a)+1,g=a.slice(e,f),h=0;h<g.length;h++)g[h].isGroup?(d.push(this._getTree(g,h)),h=this.getIndexOfLastChild(g[h],g)):d.push({field:g[h].type.field,op:{id:g[h].operator.value,text:g[h].operator.label},rhs:{realtype:g[h].type.realtype,value:g[h].value}});return c}}}).factory("$datetimeutils",function(){return{same:function(a,b){return this.modelToDate(a)===b},dateToModel:function(a){var b=a?new Date(a):new Date;return{hours:b.getHours(),minutes:b.getMinutes(),seconds:b.getSeconds(),milliseconds:b.getMilliseconds(),day:b.getDate(),month:b.getMonth()+1,year:b.getFullYear()}},modelToDate:function(a){var b=new Date;return b.setHours(+a.hours),b.setMinutes(+a.minutes),b.setSeconds(+a.seconds),b.setMilliseconds(+a.milliseconds),b.setDate(+a.day),b.setMonth(+a.month-1),b.setFullYear(+a.year),b.getTime()}}}).factory("$editorUtils",["$syntaxUtils",function(a){return{newItem:function(b,c){return{level:b.isGroup?b.level+1:b.level,type:c[0],operators:a.getOperators()[c[0].realtype],operator:a.getOperators()[c[0].realtype][0]}},getBlankAst:function(){return[{groupType:"and",isGroup:!0,level:0}]},removeItem:function(b,c){var d=c.indexOf(b);0>=d||c.splice(d,a.getChildrenCount(b,c)+1)},addAfter:function(a,b,c){b.splice(b.indexOf(a)+1,0,this.newItem(a,c))},addGroupAfter:function(a,b){var c={isGroup:!0,groupType:"and",level:a.isGroup?a.level+1:a.level};b.splice(b.indexOf(a)+1,0,c)}}}]),angular.module("percival",["percival-utils"]).directive("editor",["$editorUtils","$syntaxUtils",function(a,b){return{scope:{types:"=",conditions:"="},controller:["$scope",function(c){c.conditions&&c.types&&(c.operators=b.getOperators(),c.newItem=function(b){return a.newItem(b,c.types)},c.remove=function(b){a.removeItem(b,c.items),c.hoveredItem=void 0},c.addAfter=function(b){a.addAfter(b,c.items,c.types)},c.addGroupAfter=function(b){a.addGroupAfter(b,c.items)},c.getChildrenCount=b.getChildrenCount,c.items=b.isValidAst(c.conditions)?b.parseSyntaxTree(c.conditions,c.types):a.getBlankAst(),c.updateBounds=function(a){a?(c.min_children_index=c.items.indexOf(a),c.max_children_index=c.min_children_index+c.getChildrenCount(a,c.items)):c.min_children_index=c.max_children_index=void 0},c.$watch("items",function(){c.conditions=b.computeSyntaxTree(c.items,c.realtypes),c.updateBounds(c.hoveredItem)},!0),c.$watch("hoveredItem",c.updateBounds))}],restrict:"E",templateUrl:"conditions-template.html"}}]).directive("dateTime",["$datetimeutils",function(a){return{restrict:"E",transclude:!0,scope:{value:"="},link:function(b){b.model=a.dateToModel(b.value),b.$watch("value",function(c){a.same(b.model,c)||(b.model=a.dateToModel(c))}),b.$watch("model",function(c){a.same(c,b.value)||(b.value=a.modelToDate(c))},!0)},templateUrl:"datetime-template.html"}}]);