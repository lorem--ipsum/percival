/*! percival - v1.0.0-beta - 2013-10-17
* https://github.com/lorem--ipsum/percival
* Copyright (c) 2013 Lorem Ipsum  Licensed ,  */
angular.module("percival-utils",[]).factory("$datetimeutils",function(){return{same:function(a,b){return this.modelToDate(a)===b},dateToModel:function(a){var b=a?new Date(a):new Date;return{hours:b.getHours(),minutes:b.getMinutes(),seconds:b.getSeconds(),milliseconds:b.getMilliseconds(),day:b.getDate(),month:b.getMonth()+1,year:b.getFullYear()}},modelToDate:function(a){var b=new Date;return b.setHours(+a.hours),b.setMinutes(+a.minutes),b.setSeconds(+a.seconds),b.setMilliseconds(+a.milliseconds),b.setDate(+a.day),b.setMonth(+a.month-1),b.setFullYear(+a.year),b.getTime()}}}).factory("$editorUtils",["$syntaxUtils",function(a){return{newItem:function(b,c){return{level:b.isGroup?b.level+1:b.level,type:c[0],operators:a.getOperators()[c[0].realtype],operator:a.getOperators()[c[0].realtype][0]}},getBlankAst:function(){return[{groupType:"and",isGroup:!0,level:0}]},removeItem:function(b,c){var d=c.indexOf(b);0>=d||c.splice(d,a.getChildrenCount(b,c)+1)},addAfter:function(a,b,c){b.splice(b.indexOf(a)+1,0,this.newItem(a,c))},addGroupAfter:function(a,b){var c={isGroup:!0,groupType:"and",level:a.isGroup?a.level+1:a.level};b.splice(b.indexOf(a)+1,0,c)}}}]).factory("$syntaxUtils",function(){var a={string:[{label:"is",value:"eq"},{label:"is not",value:"neq"}],"int":[{label:"==",value:"eq"},{label:"!=",value:"ne"}],datems:[{label:">=",value:"ge"},{label:"==",value:"eq"},{label:"!=",value:"ne"},{label:">",value:"gt"},{label:"<",value:"lt"},{label:"<=",value:"le"}]};return{getOperators:function(){return a},getChildrenCount:function(a,b){for(var c=b.indexOf(a),d=0,e=a.level;c+1<b.length&&b[c+1].level>a.level;)e=b[c].level,c++,d++;return d},getIndexOfLastChild:function(a,b){for(var c=b.indexOf(a),d=a.level;c+1<b.length&&b[c+1].level>a.level;)d=b[c].level,c++;return c},parseSyntaxGroup:function(a,b){return a.and||a.or?{groupType:a.and?"and":"or",isGroup:!0,level:b}:void 0},parseSyntaxItem:function(b,c,d){var e=d.filter(function(a){return a.field===b.field})[0],f=a[e.realtype],g=f.filter(function(a){return b.op.id===a.value})[0];return{type:e,operators:a[e.realtype],operator:g,value:b.rhs.value,level:c}},parseSyntaxTree:function(a,b){return this._parseSyntaxTree(a,[],0,b)},_parseSyntaxTree:function(a,b,c,d){if(b=b||[],c=c||0,a.and||a.or){var e=this;b.push(this.parseSyntaxGroup(a,c)),(a.and||a.or).forEach(function(a){e._parseSyntaxTree(a,b,c+1,d)})}else b.push(this.parseSyntaxItem(a,c,d));return b},computeSyntaxTree:function(a){return this._getTree(a,0)},_getTree:function(a,b){for(var c={},d=c[a[b].groupType]=[],e=b+1,f=this.getIndexOfLastChild(a[b],a)+1,g=a.slice(e,f),h=0;h<g.length;h++)g[h].isGroup?(d.push(this._getTree(g,h)),h=this.getIndexOfLastChild(g[h],g)):d.push({field:g[h].type.field,op:{id:g[h].operator.value,text:g[h].operator.label},rhs:{realtype:g[h].type.realtype,value:g[h].value}});return c}}}),angular.module("percival",["percival-utils"]).directive("editor",["$editorUtils","$syntaxUtils",function(a,b){return{scope:{types:"=",conditions:"="},controller:["$scope",function(c){c.conditions&&c.types&&(c.operators=b.getOperators(),c.newItem=function(b){return a.newItem(b,c.types)},c.resetAst=function(){c.items=a.getBlankAst()},c.remove=function(b){a.removeItem(b,c.items)},c.addAfter=function(b){a.addAfter(b,c.items,c.types)},c.addGroupAfter=function(b){a.addGroupAfter(b,c.items)},c.getChildrenCount=b.getChildrenCount,c.resetAst(),c.items=b.parseSyntaxTree(c.conditions,c.types),c.updateBounds=function(a){a?(c.min_children_index=c.items.indexOf(a),c.max_children_index=c.min_children_index+c.getChildrenCount(a,c.items)):c.min_children_index=c.max_children_index=void 0},c.$watch("items",function(){c.conditions=b.computeSyntaxTree(c.items,c.realtypes),c.updateBounds(c.hoveredItem)},!0),c.$watch("hoveredItem",c.updateBounds))}],restrict:"E",templateUrl:"conditions-template.html"}}]).directive("dateTime",["$datetimeutils",function(a){return{restrict:"E",transclude:!0,scope:{value:"="},link:function(b){b.model=a.dateToModel(b.value),b.$watch("value",function(c){a.same(b.model,c)||(b.model=a.dateToModel(c))}),b.$watch("model",function(c){a.same(c,b.value)||(b.value=a.modelToDate(c))},!0)},templateUrl:"datetime-template.html"}}]);